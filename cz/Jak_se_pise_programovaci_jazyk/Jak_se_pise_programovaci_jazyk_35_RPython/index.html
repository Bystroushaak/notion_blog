<!DOCTYPE html>
<html>
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.2.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Jak se píše programovací jazyk 3.5: RPython</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css">
  <link rel="alternate" type="application/atom+xml" href="http://blog.rfox.eu/atom.xml">
  <link rel="shortcut icon" href="http://blog.rfox.eu/favicon.ico"><!-- Global site tag (gtag.js) - Google Analytics -->

  <script src="https://www.googletagmanager.com/gtag/js?id=UA-142545439-1">
  </script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-142545439-1');
  </script>
  <style>
  .hll { background-color: #ffffcc }
  .c { color: #408080; font-style: italic } /* Comment */
  .err { border: 1px solid #FF0000 } /* Error */
  .k { color: #008000; font-weight: bold } /* Keyword */
  .o { color: #666666 } /* Operator */
  .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
  .cm { color: #408080; font-style: italic } /* Comment.Multiline */
  .cp { color: #BC7A00 } /* Comment.Preproc */
  .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
  .c1 { color: #408080; font-style: italic } /* Comment.Single */
  .cs { color: #408080; font-style: italic } /* Comment.Special */
  .gd { color: #A00000 } /* Generic.Deleted */
  .ge { font-style: italic } /* Generic.Emph */
  .gr { color: #FF0000 } /* Generic.Error */
  .gh { color: #000080; font-weight: bold } /* Generic.Heading */
  .gi { color: #00A000 } /* Generic.Inserted */
  .go { color: #888888 } /* Generic.Output */
  .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
  .gs { font-weight: bold } /* Generic.Strong */
  .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
  .gt { color: #0044DD } /* Generic.Traceback */
  .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
  .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
  .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
  .kp { color: #008000 } /* Keyword.Pseudo */
  .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
  .kt { color: #B00040 } /* Keyword.Type */
  .m { color: #666666 } /* Literal.Number */
  .s { color: #BA2121 } /* Literal.String */
  .na { color: #7D9029 } /* Name.Attribute */
  .nb { color: #008000 } /* Name.Builtin */
  .nc { color: #0000FF; font-weight: bold } /* Name.Class */
  .no { color: #880000 } /* Name.Constant */
  .nd { color: #AA22FF } /* Name.Decorator */
  .ni { color: #999999; font-weight: bold } /* Name.Entity */
  .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
  .nf { color: #0000FF } /* Name.Function */
  .nl { color: #A0A000 } /* Name.Label */
  .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
  .nt { color: #008000; font-weight: bold } /* Name.Tag */
  .nv { color: #19177C } /* Name.Variable */
  .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
  .w { color: #bbbbbb } /* Text.Whitespace */
  .mb { color: #666666 } /* Literal.Number.Bin */
  .mf { color: #666666 } /* Literal.Number.Float */
  .mh { color: #666666 } /* Literal.Number.Hex */
  .mi { color: #666666 } /* Literal.Number.Integer */
  .mo { color: #666666 } /* Literal.Number.Oct */
  .sa { color: #BA2121 } /* Literal.String.Affix */
  .sb { color: #BA2121 } /* Literal.String.Backtick */
  .sc { color: #BA2121 } /* Literal.String.Char */
  .dl { color: #BA2121 } /* Literal.String.Delimiter */
  .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
  .s2 { color: #BA2121 } /* Literal.String.Double */
  .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
  .sh { color: #BA2121 } /* Literal.String.Heredoc */
  .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
  .sx { color: #008000 } /* Literal.String.Other */
  .sr { color: #BB6688 } /* Literal.String.Regex */
  .s1 { color: #BA2121 } /* Literal.String.Single */
  .ss { color: #19177C } /* Literal.String.Symbol */
  .bp { color: #008000 } /* Name.Builtin.Pseudo */
  .fm { color: #0000FF } /* Name.Function.Magic */
  .vc { color: #19177C } /* Name.Variable.Class */
  .vg { color: #19177C } /* Name.Variable.Global */
  .vi { color: #19177C } /* Name.Variable.Instance */
  .vm { color: #19177C } /* Name.Variable.Magic */
  .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@Bystroushaak">
  <meta name="twitter:creator" content="@Bystroushaak">
  <meta name="twitter:title" content="Jak se píše programovací jazyk 3.5: RPython">
  <meta name="twitter:description" content="Parser parsuje, testy procházejí a svítí zeleně. Co víc si přát. Snad jen .. Ve všemožných článcích psali, že je dobré provádět časté testy, zda jde kód přeložit RPythonem. Během psaní parseru to nemělo smysl, protože parser je obtížně dělitelný kus a moje soustředění mířilo směrem k projití unittesty. Řešit u toho ještě datové typy a všechna omezení RPythonu mi přišlo jako zbytečný masochismus, který by mohl způsobit, že projekt nikdy nedodělám.">
  <meta name="twitter:image" content="passing_tests.png">
</head>
<body>
  <div id="sidebar_top">
    <h3>New posts:</h3>
    <ul>
      <li>
        <a href="../../../en/Weekly_updates/Lifelog_2020-05-25_Work_in_progress_everywhere.html">Lifelog 2020-05-25; Work in progress everywhere</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Improvements/Vitamins_nootropics_and_other_boosters.html">Vitamins, nootropics and other boosters</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/objWiki/Transaction_support_for_simple_in_memory_database.html">Transaction support for simple in-memory database</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Improvements.html">Improvements</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Weekly_updates/Biweekly_update_2020_04_22_A_lot_of_programming.html">Biweekly update 2020-04-22; A lot of programming</a>
      </li>
    </ul>& <a href="../../../Changelog.html">more</a>
  </div><a class="breadcrumb" href="../../../index.html">Bystroushaak's blog</a> / <a class="breadcrumb" href="../../index.html">Czech section</a> / <a class="breadcrumb" href="../index.html">Jak se píše programovací jazyk</a> / Jak se píše programovací jazyk 3.5: RPython
  <article id="de209ad1-cc28-4569-bfbe-bbb8d40f277d" class="page sans">
    <header>
      <h1 class="page-title">Jak se píše programovací jazyk 3.5: RPython</h1>
    </header>
    <div class="page-body">
      <p id="ebfbab9d-0997-4d7e-9d2a-eff3a907de26" class=""><time>@2019/02/24</time></p>
      <p id="03fb45e0-8bc8-4110-8606-ae91131be017" class="">Parser parsuje, testy procházejí a svítí zeleně. Co víc si přát. Snad jen .. Ve všemožných článcích psali, že je dobré provádět časté testy, zda jde kód přeložit RPythonem. Během psaní parseru to nemělo smysl, protože parser je obtížně dělitelný kus a moje soustředění mířilo směrem k projití unittesty. Řešit u toho ještě datové typy a všechna omezení RPythonu mi přišlo jako zbytečný masochismus, který by mohl způsobit, že projekt nikdy nedodělám.</p>
      <p id="e64c2589-7e2f-439f-9776-6cd5c77c28f5" class="">Normální unittesty pouštím scriptem <code>run_tests.sh</code>, který obsahuje následující kód:</p>
      <pre class="code"><code><span class="ch">#! /usr/bin/env bash</span>
<span class="n">export</span> <span class="n">PYTHONPATH</span><span class="o">=</span><span class="s2">"src/:$PYTHONPATH"</span>
<span class="n">python2</span> <span class="o">-</span><span class="n">m</span> <span class="n">py</span><span class="o">.</span><span class="n">test</span> <span class="n">tests</span> <span class="err">$</span><span class="o">@</span>
</code></pre>
      <p id="7ae683d2-cbb0-4621-9f02-1d9b3b3e663c" class="">Ten je následně pouštěn scriptem <a href="https://github.com/joh/when-changed">when-changed</a>, jenž detekuje změny na disku a při každé úpravě zdrojových kódů pustí testy:</p>
      <pre class="code"><code><span class="n">when</span><span class="o">-</span><span class="n">changed</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">r</span> <span class="n">src</span><span class="o">/</span><span class="n">tinySelf</span><span class="o">/*.</span><span class="n">py</span> <span class="o">-</span><span class="n">r</span> <span class="n">tests</span><span class="o">/*.</span><span class="n">py</span> <span class="o">-</span><span class="n">c</span> <span class="o">./</span><span class="n">run_tests</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">s</span>
</code></pre>
      <p id="72928d2c-689a-440a-a5f4-e510cdd48e21" class="">Parametr <code>-s</code> zachycuje stdout z testů.</p>
      <figure id="81a6a1bb-d9c1-4dfb-8716-842f38073d43" class="image">
        <a href="passing_tests.png"><img style="width:600px" src="passing_tests.png"></a>
      </figure>
      <h2 id="f8a46fe1-393f-4df1-8a39-5f828968ec6b" class="">RPython testy</h2>
      <p id="e4902ad1-02a4-437f-897d-524b32399029" class="">RPython takto pouštět nemůžu, neboť se nejedná o unittesty, ale spíš test kompilace trvající na mém domácím počítači klidně minutu.</p>
      <p id="8ec866bf-d7d3-4396-97c3-7fa490f42da8" class="">Pro RPython jsem si do začátku napsal následující scriptík <code>run_rpython_test.sh</code>:</p>
      <pre class="code"><code><span class="ch">#! /usr/bin/env bash</span>
<span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="n">Plocha</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">pypy</span><span class="o">/</span><span class="n">rpython</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">rpython</span> <span class="n">src</span><span class="o">/</span><span class="n">tinySelf</span><span class="o">/</span><span class="n">target</span><span class="o">.</span><span class="n">py</span>
</code></pre>
      <h3 id="26f6065c-413a-45b5-b4c6-403839a5d1eb" class="">Pypy</h3>
      <p id="59551d7b-57cf-4390-817f-5d9dd6aa50bf" class="">Jak je možné vidět, ten předpokládá, že v adresáři <code>$HOME/Plocha/tests</code> je naklonovaný repozitář projektu <a href="https://bitbucket.org/pypy/pypy">pypy</a>. To je možné udělat například příkazem:</p>
      <pre class="code"><code><span class="n">hg</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">bitbucket</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">pypy</span><span class="o">/</span><span class="n">pypy</span>
</code></pre>
      <p id="f4e35067-f77d-42a5-90d1-fac743bc0b73" class="">ve složce <code>$HOME/Plocha/tests</code>.</p>
      <p id="204967d1-fa29-4f85-b15c-63d8c4394917" class="">Repozitář je možné zkompilovat a zajistit si tak nejnovější verzi pypy. Osobně to tak ale nedělám, protože to trvá dlouho, nejnovější revize repozitáře typicky obsahuje bugy a navíc kompilace má spoustu závislostí. Proto používám pypy z repozitáře (<code>sudo apt install pypy</code>) a využívám jen nejnovější <em>RPython toolkit</em>, který je s pypy distribuovaný.</p>
      <p id="fb56c6c8-92d4-48aa-852c-8220432702c8" class="">Jakmile mám pypy nainstalované, stáhnu si ještě PIP (python package manager) pro pypy (standardní funguje jen pro cpython):</p>
      <pre id="5de25e4b-568a-499e-8abf-ff75bc9a1336" class="code"><code>curl https://bootstrap.pypa.io/get-pip.py | sudo pypy</code></pre>
      <p id="8308f799-72b3-44eb-a6dd-6f151ed89215" class="">Poté do pypy doinstaluji nejnovější verzi parsovacího balíku <a href="https://github.com/alex/rply">rply</a>:</p>
      <pre class="code"><code><span class="n">pypy</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="n">rply</span>
</code></pre>
      <p id="935d4a2c-4387-44f2-a2f5-4f19f5539da0" class="">V repozitáři debian based systémů se nachází balík pypy-rply, který ale nedoporučuji používat, protože může být zastaralý vůči PIPu (v době psaní článku je v debian repozitáři verze 0.7.4-3 a v pipu 0.7.5).</p>
      <h1 id="6f10e555-8c51-40cd-a90a-07bd77dff1d9" class="">target.py</h1>
      <p id="11a1eba8-07b3-467d-848d-f27ee95c4728" class="">Pouštěný script <a href="http://target.py"><code>target.py</code></a> definuje vstupní kompilační bod. V něm musí být minimálně dvě funkce - <code>target()</code> a poté funkce která slouží jako vstupní bod spuštěného programu. V podstatě se jedná o takové <code>meta-main()</code> známé z C jazyků, tedy funkci určující funkci main. Mám pocit, že na linuxu se k tomu pod libc <a href="https://stackoverflow.com/questions/15919356/c-program-start">běžně používá</a> __start.</p>
      <p id="e6826aaf-91c6-47fa-8c4c-2cdb8aeac878" class="">Obsah funkce <code>target()</code> se spouští v době překladu a proto je možné v něm provádět různé meta-programování, například volat funkce, které vygenerují funkce, které jsou poté zkompilovány.</p>
      <p id="3fd1c62b-d739-487d-b1e4-e4e73070b668" class="">Osobně jsem do začátku použil jen nejjednodušší target.py:</p>
      <pre class="code"><code><span class="ch">#! /usr/bin/env python2</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">rpython.jit.codewriter.policy</span> <span class="kn">import</span> <span class="n">JitPolicy</span>
<span class="kn">from</span> <span class="nn">parser</span> <span class="kn">import</span> <span class="n">lex_and_parse</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">lex_and_parse</span><span class="p">(</span><span class="s2">"1"</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">target</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">main</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">jitpolicy</span><span class="p">(</span><span class="n">driver</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JitPolicy</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">untranslated_main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">untranslated_main</span><span class="p">()</span>
</code></pre>
      <p id="f069e582-5bd6-4ecc-8ba0-ae65db0b7773" class="">Jak je vidět, jen se pustí funkce <code>lex_and_parse("1")</code>, tedy pokus o zparsování zdrojového kódu obsahujícího jen číslo jedna.</p>
      <p id="d5153cb7-9a19-47c0-8f98-8982ac6d1540" class="">Pokud by vás zajímal princip fungování překladu na C kód, tak znovu doporučuji následující odkazy:</p>
      <ul id="c7a4d905-0444-454c-ba72-0d4679b442fe" class="bulleted-list">
        <li>
          <a href="https://www.root.cz/clanky/rpython-prekvapive-vykonny-dialekt-pythonu-na-nemz-je-zalozen-pypy/">RPython: překvapivě výkonný dialekt Pythonu, na němž je založen PyPy</a>
        </li>
      </ul>
      <ul id="3de93987-2796-45c4-87c1-7a02b69a0ea4" class="bulleted-list">
        <li>
          <a href="https://rpython.readthedocs.io/en/latest/translation.html">The RPython Toolchain</a>
        </li>
      </ul>
      <p id="6861fdd3-e634-418d-ab69-123838d3bb26" class="">Hezky to celé shrnuje následující graf:</p>
      <figure id="b47eeec8-6d29-4e48-a7c7-f804da5eaf1f" class="image">
        <a href="https://rpython.readthedocs.io/en/latest/_images/translation-detail-0.9.png"><img src="https://rpython.readthedocs.io/en/latest/_images/translation-detail-0.9.png"></a>
      </figure>
      <p id="4a636dd7-6d3b-46b7-b530-526a3d3920e2" class="">Ve zkratce je vytvořen <em>flow graf</em> kódu, který je poté projit analyzátorem datových typů, jenž se snaží jednotlivým elementům přiřadit statické datové typy. Pokud se podaří, jsou aplikovány optimizace, případně přidán JIT, vyplivnut C kód a celé je to zkompilováno pomocí normálního C kompilátoru.</p>
      <p id="bb7c31b9-73d6-4928-87be-86d01692d77a" class="">To že jde o <em>flow graf</em> ovšem znamená, že části kódu, které nejsou volány nejsou překládány. Celé je možné si to představit jako kompilaci AST, i když ve skutečnosti se kód prvně kompiluje do pythonního bytecode a teprve ten se poté analyzuje a z něj se staví <a href="https://en.wikipedia.org/wiki/Control_flow_graph">control flow graph</a>.</p>
      <p id="efe35440-7761-463b-92d1-99186d2a906f" class="">Prakticky to znamená, že pokud máte v objektu metodu, kterou nejde přeložit, tak na to nepřijdete, dokud v kódu nebude někde místo, odkud se volá. Do té doby vůbec není součástí <em>flow grafu</em>.</p>
      <h1 id="ea604512-a828-4918-ae67-a6bc8a112954" class="">První puštění testů</h1>
      <p id="303f23f5-b9c1-4d41-bb15-00b1f80f96ac" class="">První puštění testů mi samozřejmě neprošlo:</p>
      <figure id="ef1d019b-bb40-40d7-a67c-39d5ba6e67d5" class="image">
        <a href="rpython_first_fail.png"><img style="width:810px" src="rpython_first_fail.png"></a>
      </figure>
      <p id="ee62a545-6863-47eb-8fb3-b13dcac8a3de" class="">Žádné překvapení. Jak jsem psal, RPython používá silně omezenou verzi pythonu a můj kód nijak nešetří <em>list comprehensionama</em>, <em>closures</em> a dalšími „vysokoúrovňovými“ konstrukty.</p>
      <p id="0d03be9d-25b0-4f55-8808-62c3c5e1cc7d" class="">Kód je nyní zapotřebí <em>„zhloupit“</em> a přidat typové hinty, které RPythonu pomohou anotovat <em>flow graph</em> v místech, kde si je nedokáže odvodit sám.</p>
      <h2 id="ec75f321-da4b-4abf-b46b-1babf9215362" class="">Redukce na RPython</h2>
      <p id="4cec8392-13ac-44e2-80f9-c581ae4cd3de" class="">Nyní musím vzít dynamický a relativně vyskoúrovňový python a převést ho na staticky typovaný kód, který by se psal podobně jako třeba v Javě. To vše čistě v syntaxi pythonu.</p>
      <p id="ea94e078-c1d1-4357-ae96-fb09574fc9b3" class="">Část omezení je popsána v oficiální dokumentaci:</p>
      <ul id="25287908-382c-491a-9bc4-086c00794a2c" class="bulleted-list">
        <li>
          <a href="http://rpython.readthedocs.io/en/latest/rpython.html">RPython Language</a>
        </li>
      </ul>
      <p id="b2245aa6-2444-4b41-a9c1-770c588f00b3" class="">Mnohem lepší představu však dává článek</p>
      <ul id="6dbd927b-3546-4571-8e4d-6e43695a5177" class="bulleted-list">
        <li>
          <a href="https://refi64.com/posts/the-magic-of-rpython.html">The Magic of RPython</a> (<a href="http://web.archive.org/web/20180317140809/https://refi64.com/posts/the-magic-of-rpython.html">webarchive</a>)
        </li>
      </ul>
      <p id="03c8c121-24fe-409e-bf94-e7a01e2e1d91" class="">Mezi významná omezení patří například omezení proměnných pouze na jeden datový typ v daném <em>scope</em>. To znamená, že do nich nemůžete přiřadit hodnotu s jiným datovým typem, jakmile je jednou použijete. Seznamy musí být celé tvořeny z jednoho datového typu. Closures nefungují vůbec. List comprehensions fungují, ale ne úplně tak jak by člověk čekal. Generátory jsou více/méně podporovány, ale nejdou s nimi dělat různé psí kusy, jako třeba kompozice.</p>
      <p id="f76a9371-e624-4188-a449-4dd1a383006c" class="">Otravně omezující je nutnost všech funkcí v parseru vracet stejný datový typ, resp. třídu odvozenou od stejného datového typu. <code>rply</code> k tomu nabízí <a href="https://github.com/alex/rply/blob/master/rply/token.py#L1">rply.token.BaseBox</a>, od které musí být poděděny všechny AST prvky. Navíc je však ale třeba přepsat i všechny parsovací funkce tak, aby nevracely <code>list</code>, <code>dict</code>, nebo jiné nativní typy, ale datový typ odvozený od <code>BaseBox</code>u.</p>
      <p id="5a0ffda4-eb3a-4d68-a480-2d5ca8543316" class="">Proto jsem byl nucen nadefinovat třídy <code>StrContainer</code>, <code>DictContainer</code>, <code>ListContainer</code> a <code>KwSlotContainer</code>, a používat je na místech, kde jsem dříve používal prostě jen <code>dict</code>, nebo <code>list</code>. Původně jsem chtěl použít jen Container, který by udržoval obecný datový typ, ale ukázalo se, že na něj taky platí omezení a pro jednu instanci je možné použít jen jeden datový typ. Do třídy ve stylu:</p>
      <pre class="code"><code><span class="k">class</span> <span class="nc">Container</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</code></pre>
      <p id="ce7de1d9-5e6b-4feb-bef9-9675de086509" class="">není možné v různých instancích uložit různé datové typy. To je pro mě jakožto dlouhodobého programátora v pythonu docela nezvyk.</p>
      <p id="6593d087-a9fc-4a71-aa6e-e881002758ab" class="">Hezky je to vidět například na parsovací funkci <code>kw_slot_definition()</code>, která se proměnila z</p>
      <pre class="code"><code><span class="nd">@pg</span><span class="o">.</span><span class="n">production</span><span class="p">(</span><span class="s1">'slot_definition : kw_slot_name ASSIGNMENT expression'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">kw_slot_definition</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Object</span><span class="p">),</span> <span class="s2">"Only objects are assignable to kw slots!"</span>

    <span class="n">slot_name</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">slot_name</span><span class="p">:</span> <span class="n">obj</span><span class="p">}</span>
</code></pre>
      <p id="8eb34dc5-8861-439d-a3c7-9d69c2554459" class="">na</p>
      <pre class="code"><code><span class="nd">@pg</span><span class="o">.</span><span class="n">production</span><span class="p">(</span><span class="s1">'slot_definition : kw_slot_name ASSIGNMENT expression'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">kw_slot_definition</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">slot_info</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_info</span><span class="p">,</span> <span class="n">KwSlotContainer</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Object</span><span class="p">)</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">slot_info</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">DictContainer</span><span class="p">({</span><span class="n">slot_info</span><span class="o">.</span><span class="n">slot_name</span><span class="p">:</span> <span class="n">obj</span><span class="p">})</span>
</code></pre>
      <p id="e6dc9ff0-a859-4905-9d25-ccbb77562d79" class="">Za povšimnutí stojí také několik použití <code>assert isinstance(..)</code>. V prvním případě používám <code>assert</code> tak, jak byl zamýšlen, tedy k ujištění se, že do funkce nepoleze datový typ jiný než objekt a pokud ano, tak vyhodím chybovou hlášku.</p>
      <p id="6d9a221e-2a05-419e-ad6d-c135a2513e9b" class="">Ve druhém případě <code>assert</code> nefunguje jako příkaz pro ujištění, ale jako <em>type hint</em> (<em>typová nápověda</em>) pro RPython, který mu říká, jakého datového typu jsou dané parametry. Pokud bych ho neuvedl, došlo by v době překladu k vyhození výjimky, která může vypadat například takto:</p>
      <pre class="code"><code><span class="p">[</span><span class="n">translation</span><span class="p">:</span><span class="n">ERROR</span><span class="p">]</span> <span class="n">NoSuchAttrError</span><span class="p">:</span> 

<span class="n">the</span> <span class="n">attribute</span> <span class="s1">'params'</span> <span class="n">goes</span> <span class="n">here</span> <span class="n">to</span> <span class="o">&lt;</span><span class="n">ClassDef</span> <span class="s1">'rply.token.BaseBox'</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">but</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">forbidden</span> <span class="n">here</span>


    <span class="n">v0</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj_0</span><span class="p">,</span> <span class="p">(</span><span class="s1">'params'</span><span class="p">))</span>

<span class="n">In</span> <span class="o">&lt;</span><span class="n">FunctionGraph</span> <span class="n">of</span> <span class="p">(</span><span class="n">parser</span><span class="p">:</span><span class="mi">453</span><span class="p">)</span><span class="n">kw_slot_definition</span> <span class="n">at</span> <span class="mh">0x55b7e3841cc8</span><span class="o">&gt;</span><span class="p">:</span>
<span class="n">Happened</span> <span class="n">at</span> <span class="n">file</span> <span class="n">src</span><span class="o">/</span><span class="n">tinySelf</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">py</span> <span class="n">line</span> <span class="mi">461</span>

        <span class="n">slot_info</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
        <span class="c1"># assert isinstance(slot_info, KwSlotContainer)</span>
        <span class="c1"># assert isinstance(obj, Object)</span>
    
<span class="o">==&gt;</span>     <span class="n">obj</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">slot_info</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">DictContainer</span><span class="p">({</span><span class="n">slot_info</span><span class="o">.</span><span class="n">slot_name</span><span class="p">:</span> <span class="n">obj</span><span class="p">})</span>
</code></pre>
      <p id="49c65f87-61bb-4fc0-899a-07138ffe8af0" class="">Z chyby je jasně vidět, že RPython nechápe, proč se snažím u neznámého objektu přistupovat k členské proměnné <code>params</code>.</p>
      <p id="d9211181-94ee-458c-8da2-2a3dc4e55809" class="">Na konci funkce pak vracím <code>DictContainer</code> čistě jen proto, že vrácené parsované hodnoty musí být všechny stejným datovým typem, nebo jeho potomky. To je způsobeno vnitřním fungováním parseru, který jednotlivé odekorované funkce zpracovává v různých kolekcích, ve kterých nemůžou být pod RPythonem různé datové typy.</p>
      <p id="7238ea02-8f98-405a-a238-bd39742dde4b" class="">Zajímavé jsou chyby <code>Blocked block -- operation cannot succeed</code>, které mi jeden večer docela zamotaly hlavu. Nakonec jsem však prohledáním konference zjistil, že se jedná o chybu když RPython type annotator prvně vleze do metody objektu a ještě neprošel <code>.__init__()</code> metodu. Pokud je v metodě přistoupeno k členským proměnným, tak dojde chybě, jelikož anotátor neví o tom že byly definovány. Řešení je docela prosté, stačí objekt prostě předtím někde použít, aby byla o-anotována <code>.__init__()</code> metoda.</p>
      <h2 id="9a496d5f-10b9-4da6-8548-ab9f084c167c" class="">Překlad</h2>
      <p id="2fae3c5e-830a-43f3-b387-52b44fec2f00" class="">Výše uvedené potíže jsou jen malá část toho, s čím se člověk setká. Osobně jsem postupoval tak, že jsem celý parser až na první pravidlo a poslední parsovací funkci <code>parse_and_lex()</code> zakomentoval a postupně převáděl jednotlivá pravidla. Tímhle postupem mi to trvalo poměrně dlouho, ale nakonec se dostavil výsledek:</p>
      <figure id="ec340534-cd5a-4762-8984-d8ba71ea1ed5" class="image">
        <a href="compilation.gif"><img style="width:896px" src="compilation.gif"></a>
      </figure>
      <p id="6b05db44-5d5b-4a62-98a3-9b29fe5f70cd" class=""><em>(Kompilační fraktály v původní kvalitě:</em> <em><a href="https://youtu.be/A_OhtmUH830">https://youtu.be/A_OhtmUH830</a></em><em>)</em></p>
      <h1 id="ea87c7ac-48fb-4ba0-af65-7c044bf42bb0" class="">Pokračování</h1>
      <p id="090d3364-ee9f-48d2-a3bf-497ee5bf0195" class="">Příště se podíváme na návrh rozložení a reprezentace objektů v paměti před tím, než přijde na řadu psaní virtuálního stroje a kompilátoru do bytecode.</p>
      <h1 id="b1e1c147-14bb-4424-82bb-bdf222a7c238" class="">Relevantní diskuze</h1>
      <ul id="46b4620c-c297-4e75-926b-094e212b43ab" class="bulleted-list">
        <li>
          <a href="http://www.abclinuxu.cz/blog/bystroushaak/2019/2/jak-se-pise-programovaci-jazyk-3.5-rpython">Jak se píše programovací jazyk 3.5: RPython</a> (abclinuxu)
        </li>
      </ul>
      <p id="8b29ea42-1b6a-4753-90cc-41593cf8831a" class=""></p>
    </div>
  </article>
  <div class="corner-ribbon top-right red">
    <a href="https://www.patreon.com/bePatron?u=2618881">Become a Patron</a>
  </div>
  <div id="sidebar_bottom">
    <h3>New posts:</h3>
    <ul>
      <li>
        <a href="../../../en/Weekly_updates/Lifelog_2020-05-25_Work_in_progress_everywhere.html">Lifelog 2020-05-25; Work in progress everywhere</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Improvements/Vitamins_nootropics_and_other_boosters.html">Vitamins, nootropics and other boosters</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/objWiki/Transaction_support_for_simple_in_memory_database.html">Transaction support for simple in-memory database</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Improvements.html">Improvements</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Weekly_updates/Biweekly_update_2020_04_22_A_lot_of_programming.html">Biweekly update 2020-04-22; A lot of programming</a>
      </li>
    </ul>& <a href="../../../Changelog.html">more</a>
  </div>
</body>
</html>
