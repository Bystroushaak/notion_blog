<!DOCTYPE html>
<html>
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.2.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>The "traits float" bug 2020/1</title>
  <link rel="stylesheet" type="text/css" href="../../style.css">
  <link rel="alternate" type="application/atom+xml" href="http://blog.rfox.eu/atom.xml">
  <link rel="shortcut icon" href="http://blog.rfox.eu/favicon.ico"><!-- Global site tag (gtag.js) - Google Analytics -->

  <script src="https://www.googletagmanager.com/gtag/js?id=UA-142545439-1">
  </script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-142545439-1');
  </script>
  <style>
  .hll { background-color: #ffffcc }
  .c { color: #408080; font-style: italic } /* Comment */
  .err { border: 1px solid #FF0000 } /* Error */
  .k { color: #008000; font-weight: bold } /* Keyword */
  .o { color: #666666 } /* Operator */
  .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
  .cm { color: #408080; font-style: italic } /* Comment.Multiline */
  .cp { color: #BC7A00 } /* Comment.Preproc */
  .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
  .c1 { color: #408080; font-style: italic } /* Comment.Single */
  .cs { color: #408080; font-style: italic } /* Comment.Special */
  .gd { color: #A00000 } /* Generic.Deleted */
  .ge { font-style: italic } /* Generic.Emph */
  .gr { color: #FF0000 } /* Generic.Error */
  .gh { color: #000080; font-weight: bold } /* Generic.Heading */
  .gi { color: #00A000 } /* Generic.Inserted */
  .go { color: #888888 } /* Generic.Output */
  .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
  .gs { font-weight: bold } /* Generic.Strong */
  .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
  .gt { color: #0044DD } /* Generic.Traceback */
  .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
  .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
  .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
  .kp { color: #008000 } /* Keyword.Pseudo */
  .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
  .kt { color: #B00040 } /* Keyword.Type */
  .m { color: #666666 } /* Literal.Number */
  .s { color: #BA2121 } /* Literal.String */
  .na { color: #7D9029 } /* Name.Attribute */
  .nb { color: #008000 } /* Name.Builtin */
  .nc { color: #0000FF; font-weight: bold } /* Name.Class */
  .no { color: #880000 } /* Name.Constant */
  .nd { color: #AA22FF } /* Name.Decorator */
  .ni { color: #999999; font-weight: bold } /* Name.Entity */
  .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
  .nf { color: #0000FF } /* Name.Function */
  .nl { color: #A0A000 } /* Name.Label */
  .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
  .nt { color: #008000; font-weight: bold } /* Name.Tag */
  .nv { color: #19177C } /* Name.Variable */
  .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
  .w { color: #bbbbbb } /* Text.Whitespace */
  .mb { color: #666666 } /* Literal.Number.Bin */
  .mf { color: #666666 } /* Literal.Number.Float */
  .mh { color: #666666 } /* Literal.Number.Hex */
  .mi { color: #666666 } /* Literal.Number.Integer */
  .mo { color: #666666 } /* Literal.Number.Oct */
  .sa { color: #BA2121 } /* Literal.String.Affix */
  .sb { color: #BA2121 } /* Literal.String.Backtick */
  .sc { color: #BA2121 } /* Literal.String.Char */
  .dl { color: #BA2121 } /* Literal.String.Delimiter */
  .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
  .s2 { color: #BA2121 } /* Literal.String.Double */
  .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
  .sh { color: #BA2121 } /* Literal.String.Heredoc */
  .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
  .sx { color: #008000 } /* Literal.String.Other */
  .sr { color: #BB6688 } /* Literal.String.Regex */
  .s1 { color: #BA2121 } /* Literal.String.Single */
  .ss { color: #19177C } /* Literal.String.Symbol */
  .bp { color: #008000 } /* Name.Builtin.Pseudo */
  .fm { color: #0000FF } /* Name.Function.Magic */
  .vc { color: #19177C } /* Name.Variable.Class */
  .vg { color: #19177C } /* Name.Variable.Global */
  .vi { color: #19177C } /* Name.Variable.Instance */
  .vm { color: #19177C } /* Name.Variable.Magic */
  .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@Bystroushaak">
  <meta name="twitter:creator" content="@Bystroushaak">
  <meta name="twitter:title" content="The &quot;traits float&quot; bug 2020/1">
  <meta name="twitter:description" content="Here is update from the development of tinySelf, my pet programming language inspired by Smalltalk and Self.">
  <meta name="twitter:image" content="http://blog.rfox.eu/en/tinySelf/The_traits_float_bug_2020-1/floats_explanation.png">
  <script src="../../scripts.js">
  </script>
</head>
<body onload="on_body_load();">
  <div id="sidebar_top">
    <h3>New posts:</h3>
    <ul>
      <li>
        <a href="../Weekly_updates/Lifelog_2020-05-25_Work_in_progress_everywhere.html">Lifelog 2020-05-25; Work in progress everywhere</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Improvements/Vitamins_nootropics_and_other_boosters.html">Vitamins, nootropics and other boosters</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/objWiki/Transaction_support_for_simple_in_memory_database.html">Transaction support for simple in-memory database</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Improvements.html">Improvements</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Weekly_updates/Biweekly_update_2020_04_22_A_lot_of_programming.html">Biweekly update 2020-04-22; A lot of programming</a>
      </li>
    </ul>& <a href="../../Changelog.html">more</a>
  </div><a class="breadcrumb" href="../../index.html">Bystroushaak's blog</a> / <a class="breadcrumb" href="../index.html">English section</a> / <a class="breadcrumb" href="index.html">tinySelf</a> / The "traits float" bug 2020/1
  <article id="baee4985-ca94-4afc-9241-0fa00939e7de" class="page sans">
    <header>
      <h1 class="page-title">The "traits float" bug 2020/1</h1>
    </header>
    <div class="page-body">
      <p id="3c9a6d8f-c9f2-4849-8ea6-fa0e9249611e" class=""><time>@2020/01/19</time></p>
      <p id="9e990555-5039-4ef7-97cb-b1e6d17bc168" class="">Here is update from the development of tinySelf, my pet programming language inspired by Smalltalk and <a href="http://www.selflanguage.org/">Self</a>.</p>
      <p id="236c6a79-ca9b-4a5c-8bca-1edb33bd2e67" class="">When I was adding new methods to primitive types, I've encountered a nasty bug. The bug was caused by sharing primitive method objects for all instances of <code>float</code> (and <code>int</code>, <code>bool</code> and other primitive data types). By default, when <code>float</code> object is created, it has a bunch of primitive slots that are pre-filled with <em>primitive code objects</em>. This is quite costly, both in terms of memory and time.</p>
      <figure id="965c819f-428d-4ce1-b2b2-e37c805ec2ad" class="image">
        <a href="The_traits_float_bug_2020-1/floats_explanation.png"><img style="width:528px" src="The_traits_float_bug_2020-1/floats_explanation.png"></a>
      </figure>
      <p id="e51abe22-3f2d-4105-99a6-1523f976d15e" class="">If you had multiple instances, whole structure would look like this:</p>
      <figure id="1bc32327-3b99-446c-aa2a-87a545f19466" class="image">
        <a href="The_traits_float_bug_2020-1/default_floats.png"><img style="width:288px" src="The_traits_float_bug_2020-1/default_floats.png"></a>
      </figure>
      <p id="38c46047-c424-40b3-9c58-e01371d16e6c" class="">Naturally, I've tried to add caching mechanism, that already works with other primitive objects, like <code>true</code>, <code>false</code> and <code>nil</code>:</p>
      <p id="1de51009-9014-42b7-b123-a66d9e238928" class=""></p>
      <figure id="550b8ea7-2a0f-4e0c-8587-6d1910b829a7" class="image">
        <a href="The_traits_float_bug_2020-1/shared_primitive_method_objects.png"><img style="width:240px" src="The_traits_float_bug_2020-1/shared_primitive_method_objects.png"></a>
      </figure>
      <p id="7fded033-ba2d-48a6-9383-f0b2a5362a4f" class="">To my surprise, what happened is that when used for the first time, it worked as expected. But when you used the primitive method in another float object, the <code>self</code> for primitive methods got redirected to the object used before. Interpreter uses this branch for handling primitive code:</p>
      <pre class="code"><code><span class="k">elif</span> <span class="n">slot</span><span class="o">.</span><span class="n">has_primitive_code</span><span class="p">:</span>
    <span class="c1"># primitives need "self" to be actually the object they are expecting,</span>
    <span class="c1"># for example for dicts it have to be dict, not some descendant</span>
    <span class="c1"># in the parent chain</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">slot_found_directly_in_obj</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="n">scope_parent</span>

    <span class="n">return_value</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="n">primitive_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">,</span>
        <span class="n">parameters</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">return_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>
</code></pre>
      <p id="4829747e-bda7-41c0-8c48-23e652b5c3e2" class=""><code>.primitive_code()</code> method is a primitive (in rpython implemented) function expecting three parameters: <code>interpreter</code>, <code>self</code> and <code>parameters</code>.</p>
      <p id="56df5432-c4b6-4cf1-a018-798b1039deec" class="">The second parameter <code>obj</code> which is mapped to <code>self</code> in the primitive function was in this case wrong, because it was resolved from <code>traits float</code>. <code>slot_found_directly_in_obj</code> was <code>False</code>, and <code>slot</code> had <code>.scope_parent</code> property set to last object in which context it was used. This happened to be primitive from previous call.</p>
      <p id="97c61eca-cc62-4faf-a633-ce75c6759963" class="">Fixing this was easy, but figuring where to find correct object which should be used as <code>self</code> parameter for the primitive was hard. I've thought (and tried) about storing last primitive in call frame. I've explored a path to store <code>(obj, primitive)</code> pairs on the stack, or creating linked primitive stacks in each frame, and several other ways. At the end, I've solved this by looking into the <code>.scope_parent</code> of the <code>obj</code> (which is at that time currently executed method). As the parameters are mapped into the <code>.scope_parent</code> properties, this can be used as history. Code now looks like this:</p>
      <pre class="code"><code><span class="k">elif</span> <span class="n">slot</span><span class="o">.</span><span class="n">has_primitive_code</span><span class="p">:</span>
    <span class="c1"># primitives need "self" to be actually the object they are expecting,</span>
    <span class="c1"># for example for dicts it have to be dict, not some descendant</span>
    <span class="c1"># in the parent chain</span>
    <span class="n">primitive_self</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">slot_found_directly_in_obj</span><span class="p">:</span>
        <span class="n">primitive_self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_primitives_self</span><span class="p">(</span><span class="n">primitive_self</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>

    <span class="n">return_value</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="n">primitive_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>            <span class="c1"># mapped to `interpreter`</span>
        <span class="n">primitive_self</span><span class="p">,</span>  <span class="c1"># mapped to `self`</span>
        <span class="n">parameters</span>       <span class="c1"># mapped to `params`</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">return_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>
</code></pre>
      <p id="adc52944-4adc-47c9-8cd7-ec7cc02acb10" class="">...</p>
      <pre class="code"><code><span class="k">def</span> <span class="nf">_find_primitives_self</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive_self</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    In case of primitives that were resolved from traits, it is more</span>
<span class="sd">    complicated to find `self` parameter for the primitive function.</span>

<span class="sd">    See tinySelf.vm.primitives.add_primitive_fn.add_primitive_fn() and</span>
<span class="sd">    #132 for details.</span>

<span class="sd">    Args:</span>
<span class="sd">        primitive_self (Object): Candidate for the primitive's self.</span>
<span class="sd">        slot (Object): Method slot with primitive code.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Object: Correct primitive self.</span>
<span class="sd">    """</span>
    <span class="c1"># for slots resolved from the primitive classes (list, float, ..)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">PrimitiveCodeMethodObject</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">slot</span><span class="o">.</span><span class="n">scope_parent</span>

    <span class="c1"># for slots resolved from traits go up the parent scope chain until you</span>
    <span class="c1"># find instance of the class from which this was resolved</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">primitive_self</span><span class="p">,</span> <span class="n">slot</span><span class="o">.</span><span class="n">scope_parent</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
        <span class="n">primitive_self</span> <span class="o">=</span> <span class="n">primitive_self</span><span class="o">.</span><span class="n">scope_parent</span>
        <span class="k">if</span> <span class="n">primitive_self</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">primitive_self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">universe</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">primitive_self</span>
</code></pre>
      <p id="4bc15ab8-03e7-491a-af48-fc283de4aa26" class="">It's not the cleanest solution, but it is simple and it works.</p>
      <h2 id="89626af1-0211-4864-9510-fb0cc8dc1b45" class="">On the difficulty</h2>
      <p id="2e00aac1-c7a3-4c49-aab5-52e94889d8dd" class="">Although that written like this it may look simple, this wasn't easy debugging at all. It took a lot of tracing and prints and breakpoints and logging breakpoints and mental modeling to figure what is happening.</p>
      <p id="acfc735b-f00b-4113-a7b8-c99a53c64620" class="">I've had really hard time when I tried to hold all the variables, different places, stack frames, contexts, objects and their copies and instances in my head. In the end, I was saved by outsourcing to the paper and resorting to visual memory. This sketch really helped me a lot:</p>
      <figure id="c129763b-4073-4040-b8be-9973a5acb2fe" class="image">
        <a href="The_traits_float_bug_2020-1/tinySelf_debugging.jpg"><img style="width:1600px" src="The_traits_float_bug_2020-1/tinySelf_debugging_thumb.jpg"></a>
      </figure>
      <p id="0cbe7cab-f347-4bd8-b477-e67b88010c5a" class="">What do you use for debugging? Do you have any killer technique?</p>
      <hr id="db75e3ea-e4e8-412e-9df0-2a5ef76af082">
      <figure class="block-color-gray_background callout" id="0380b223-4dd7-4f55-a066-34d3cc62df5f" style="display:flex">
        <div style="font-size:1.5em">
          <span class="icon">💡</span>
        </div>
        <div style="width:100%">
          Yes, my English is probably horrible, but this kind of blog post doesn't qualify for (paid) grammar corrections yet (there is stuff with higher precedence in queue). If you want to change this, <a href="https://www.patreon.com/bePatron?u=2618881">subscribe to my patreon</a>. Even with a $1 / month, you can make a difference.
        </div>
      </figure>
    </div>
  </article>
  <div class="corner-ribbon top-right red">
    <a href="https://www.patreon.com/bePatron?u=2618881">Become a Patron</a>
  </div><a class="twitter-share-button" id="twitter_button" href="#"><img src="../../tweet_button.svg"></a>
  <div id="sidebar_bottom">
    <h3>New posts:</h3>
    <ul>
      <li>
        <a href="../Weekly_updates/Lifelog_2020-05-25_Work_in_progress_everywhere.html">Lifelog 2020-05-25; Work in progress everywhere</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Improvements/Vitamins_nootropics_and_other_boosters.html">Vitamins, nootropics and other boosters</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/objWiki/Transaction_support_for_simple_in_memory_database.html">Transaction support for simple in-memory database</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Improvements.html">Improvements</a>
      </li>
      <li>
        <a href="http://blog.rfox.eu/en/Weekly_updates/Biweekly_update_2020_04_22_A_lot_of_programming.html">Biweekly update 2020-04-22; A lot of programming</a>
      </li>
    </ul>& <a href="../../Changelog.html">more</a>
  </div>
</body>
</html>
